## 安装gdb并调试程序

```shell
apt install gdb build-essential gcc
```

新建一个`test.c`文件

```c
#include <stdio.h>
#include <stdlib.h>

void segfault() {
    char *ptr = NULL;
    *ptr = 'a';  // 引发段错误
}

int main() {
    segfault();
    return 0;
}
```

## 配置core dumps

```shell
if ! grep -qi 'kernel.core_pattern' /etc/sysctl.conf; then
  sudo sh -c 'echo "kernel.core_pattern=core.%p.%u.%s.%e.%t" >> /etc/sysctl.conf'
  sudo sysctl -p
fi
ulimit -c unlimited

cat << EOF > /etc/security/limits.conf
* soft core unlimited
* hard core unlimited
EOF
```

`* soft core unlimited`和`* hard core unlimited`为配置对生成core dump无限制。

`/etc/sysctl.conf`内追加的是core文件格式。

## 编译c文件执行脚本

```shell
$ gcc -ggdb test.c -o test
$ ./test
段错误（核心已转储）
$ ls
core.695.1000.11.test.1730276180  test  test.c
```

`-ggdb`指定了使用gdb兼容的格式debug。`-o`指定可执行文件的文件名

核心已转储后，当前路径下生成了转储文件：core.695.1000.11.test.1730276180

## 使用gdb分析core dump文件

```shell
$ gdb ./test ./core.695.1000.11.test.1730276180
GNU gdb (Debian 13.1-3) 13.1
Copyright (C) 2023 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.
Type "show copying" and "show warranty" for details.
This GDB was configured as "aarch64-linux-gnu".
Type "show configuration" for configuration details.
For bug reporting instructions, please see:
<https://www.gnu.org/software/gdb/bugs/>.
Find the GDB manual and other documentation resources online at:
    <http://www.gnu.org/software/gdb/documentation/>.

For help, type "help".
Type "apropos word" to search for commands related to "word"...
Reading symbols from ./test...
[New LWP 695]
[Thread debugging using libthread_db enabled]
Using host libthread_db library "/lib/aarch64-linux-gnu/libthread_db.so.1".
Core was generated by `./test'.
Program terminated with signal SIGSEGV, Segmentation fault.
#0  0x0000aaaadfbe0724 in segfault () at test.c:6
6	    *ptr = 'a';  // 引发段错误
(gdb)
```

从gdb打印信息我们可以看出core dump是执行`./test`程序生成的。程序被`SIGSEGV`信号中断错误原因是`Segmentation fault.`

出错的地方在`#0`帧，`segfault ()`方法，`test.c:6`test.c文件第6行。

## 回溯命令bt

```shell
(gdb) bt
#0  0x0000aaaadfbe0724 in segfault () at test.c:6
#1  0x0000aaaadfbe0740 in main () at test.c:10
(gdb)
```

## 帧查看

```shell
(gdb) f 0
#0  0x0000aaaadfbe0724 in segfault () at test.c:6
6	    *ptr = 'a';  // 引发段错误
(gdb) f 1
#1  0x0000aaaadfbe0740 in main () at test.c:10
10	    segfault();
(gdb)
```

